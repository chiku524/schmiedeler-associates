<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äî Inbox | Schmiedeler &amp; Associates</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/png" href="assets/favicon.png" sizes="32x32" />
  <link rel="stylesheet" href="css/style.css?v=2" />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700&family=Source+Sans+3:ital,wght@0,400;0,600;0,700&display=swap" rel="stylesheet" />
  <style>
    .admin-header { position: sticky; top: 0; z-index: 100; background: var(--color-surface); border-bottom: 1px solid var(--color-trace); }
    .admin-header-inner { max-width: 100%; margin: 0; padding: var(--space-sm) var(--space-md); display: flex; align-items: center; justify-content: space-between; }
    .admin-header-logo { font-family: var(--font-heading); font-weight: 700; color: var(--color-navy-dark); text-decoration: none; font-size: 1.2rem; }
    .admin-header-portal { font-weight: 600; color: var(--color-navy); text-decoration: none; padding: var(--space-xs) var(--space-sm); border-radius: var(--radius); }
    .admin-theme-toggle { width: 40px; height: 40px; border: none; border-radius: var(--radius); background: var(--color-bg-alt); color: var(--color-navy); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: color 0.2s, background 0.2s; }
    .admin-theme-toggle:hover { color: var(--color-accent); background: var(--color-surface); }
    .admin-theme-toggle:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }
    .admin-theme-icon { display: none; }
    .admin-theme-sun { display: inline !important; }
    html[data-theme="dark"] .admin-theme-sun { display: none !important; }
    html[data-theme="dark"] .admin-theme-moon { display: inline !important; }
    .admin-login-wrap { max-width: 28rem; margin: 3rem auto; padding: var(--space-xl); background: var(--color-surface); border-radius: 14px; box-shadow: var(--shadow-lg); border: 1px solid var(--color-trace); }
    .admin-login-wrap .admin-title { font-size: 1.75rem; letter-spacing: -0.02em; color: var(--color-navy); }
    .admin-login-wrap .section-intro { color: var(--color-text-muted); font-size: 1rem; }
    .admin-login label { display: block; font-weight: 600; margin-bottom: var(--space-xs); font-size: 0.9rem; color: var(--color-navy); }
    .admin-login input { width: 100%; padding: 0.65rem 0.9rem; border: 1px solid var(--color-trace); border-radius: 8px; font-size: 1rem; background: var(--color-surface); color: var(--color-text); transition: border-color 0.2s, box-shadow 0.2s; }
    .admin-login input:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px var(--color-trace-accent); }
    .admin-login button { margin-top: var(--space-md); width: 100%; padding: 0.65rem 1rem; font-weight: 600; border-radius: 8px; }
    .admin-error { color: #dc2626; margin-top: var(--space-sm); font-size: 0.9rem; }

    .admin-app { display: flex; min-height: calc(100vh - 52px); }
    .admin-sidebar { width: 240px; flex-shrink: 0; background: var(--color-bg-alt); border-right: 1px solid var(--color-trace); padding: var(--space-lg) 0; }
    .admin-sidebar .nav-item { display: flex; align-items: center; justify-content: space-between; padding: var(--space-sm) var(--space-lg); color: var(--color-navy); text-decoration: none; font-weight: 600; cursor: pointer; border: none; background: none; width: 100%; text-align: left; font-size: 0.95rem; border-left: 3px solid transparent; margin-left: 0; transition: background 0.15s, color 0.15s, border-color 0.15s; }
    .admin-sidebar .nav-item:hover { background: var(--color-surface); color: var(--color-accent); }
    .admin-sidebar .nav-item.active { background: var(--dept-general-bg); color: var(--color-accent); border-left-color: var(--color-accent); padding-left: calc(var(--space-lg) - 3px); }
    .admin-sidebar .nav-item[data-dept="sales"].active { background: var(--dept-sales-bg); color: var(--dept-sales); border-left-color: var(--dept-sales); }
    .admin-sidebar .nav-item[data-dept="accounting"].active { background: var(--dept-accounting-bg); color: var(--dept-accounting); border-left-color: var(--dept-accounting); }
    .admin-sidebar .nav-count { font-size: 0.8rem; color: var(--color-text-muted); font-weight: 600; min-width: 1.5rem; text-align: right; }
    .admin-sidebar .nav-item.active .nav-count { color: inherit; }
    .admin-gmail-wrap { padding: var(--space-lg); border-top: 1px solid var(--color-trace); margin-top: var(--space-sm); }
    .admin-gmail-status { font-size: 0.85rem; color: var(--color-text-muted); }
    .admin-gmail-status.flash { color: var(--color-accent); animation: admin-flash 2s ease; }
    @keyframes admin-flash { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 1; } }
    .admin-sidebar .logout-wrap { padding: var(--space-md); border-top: 1px solid var(--color-trace); margin-top: 0; }
    .admin-main { flex: 1; min-width: 0; display: flex; flex-direction: column; background: var(--color-surface); }
    .admin-toolbar { padding: var(--space-md) var(--space-lg); border-bottom: 1px solid var(--color-trace); font-weight: 600; color: var(--color-navy); display: flex; align-items: center; gap: var(--space-md); flex-wrap: wrap; background: var(--color-surface); }
    .admin-toolbar-label { font-size: 1rem; letter-spacing: -0.01em; }
    .admin-toolbar .refresh-btn { margin-left: auto; }
    .admin-emaillist { flex: 1; overflow-y: auto; min-height: 200px; }
    .admin-emailrow { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md) var(--space-lg); border-bottom: 1px solid var(--color-trace); cursor: pointer; transition: background 0.15s, border-left-color 0.15s; border-left: 3px solid transparent; }
    .admin-emailrow:hover { background: var(--color-bg-alt); }
    .admin-emailrow:focus { outline: none; background: var(--color-bg-alt); border-left-color: var(--color-accent); }
    .admin-emailrow .avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--color-accent); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; flex-shrink: 0; }
    .admin-emailrow .meta { flex: 1; min-width: 0; }
    .admin-emailrow .from-line { display: flex; align-items: center; gap: var(--space-sm); margin-bottom: 4px; }
    .admin-emailrow .from-name { font-weight: 600; color: var(--color-navy); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .admin-emailrow .date { font-size: 0.8rem; color: var(--color-text-muted); flex-shrink: 0; }
    .admin-emailrow .subject { font-weight: 600; color: var(--color-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95rem; }
    .admin-emailrow .snippet { font-size: 0.875rem; color: var(--color-text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
    .admin-empty-inbox { padding: var(--space-2xl) var(--space-lg); text-align: center; color: var(--color-text-muted); }
    .admin-empty-inbox .empty-icon { font-size: 3.5rem; margin-bottom: var(--space-sm); opacity: 0.4; display: block; }
    .admin-empty-inbox p { margin: 0 0 var(--space-xs); font-size: 1rem; }

    .admin-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: var(--space-lg); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
    .admin-modal-overlay[hidden] { display: none; }
    .admin-modal-box { background: var(--color-surface); border-radius: 14px; box-shadow: 0 24px 56px rgba(0,0,0,0.18), 0 0 0 1px var(--color-trace); max-width: 700px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
    .admin-modal-header { padding: var(--space-lg) var(--space-xl); border-bottom: 1px solid var(--color-trace); display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-md); background: var(--color-surface); }
    .admin-modal-header-content { flex: 1; min-width: 0; }
    .admin-modal-dept-badge { display: inline-block; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-accent); background: var(--dept-general-bg); padding: 0.25rem 0.5rem; border-radius: 6px; margin-bottom: 0.35rem; }
    .admin-modal-dept-badge.dept-sales { color: var(--dept-sales); background: var(--dept-sales-bg); }
    .admin-modal-dept-badge.dept-accounting { color: var(--dept-accounting); background: var(--dept-accounting-bg); }
    .admin-modal-header h2 { margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--color-navy); letter-spacing: -0.02em; line-height: 1.3; }
    .admin-modal-close { width: 38px; height: 38px; border: none; border-radius: 8px; background: transparent; color: var(--color-text-muted); font-size: 1.5rem; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s, color 0.2s; }
    .admin-modal-close:hover { background: var(--color-bg-alt); color: var(--color-navy); }
    .admin-modal-close:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }
    .admin-modal-body { padding: var(--space-lg) var(--space-xl); overflow-y: auto; flex: 1; min-height: 0; }
    .admin-modal-section-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--color-text-muted); margin-bottom: var(--space-sm); }
    .admin-modal-inbound { background: var(--color-bg-alt); border-radius: 10px; padding: var(--space-lg); margin-bottom: var(--space-lg); border: 1px solid var(--color-trace); }
    .admin-modal-inbound .admin-modal-section-label { color: var(--color-text-muted); }
    .admin-modal-email-from, .admin-modal-email-to { font-size: 0.9rem; margin-bottom: var(--space-xs); color: var(--color-text); }
    .admin-modal-email-from strong, .admin-modal-email-to strong { color: var(--color-navy); }
    .admin-modal-email-date { font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: var(--space-md); }
    .admin-modal-email-msg { white-space: pre-wrap; word-break: break-word; font-size: 0.95rem; color: var(--color-text); line-height: 1.6; padding-top: var(--space-md); border-top: 1px solid var(--color-trace); margin-top: var(--space-sm); }
    .admin-modal-reply { padding: var(--space-xl); border-top: 1px solid var(--color-trace); background: linear-gradient(to bottom, rgba(180, 83, 9, 0.05), rgba(180, 83, 9, 0.02)); }
    .admin-modal-reply .admin-modal-section-label { color: var(--color-accent); }
    .admin-reply-from-note { font-weight: 400; text-transform: none; letter-spacing: 0; font-size: 0.75rem; opacity: 0.9; }
    .admin-modal-reply label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: var(--space-xs); color: var(--color-navy); }
    .admin-modal-reply input[type="text"] { width: 100%; padding: 0.55rem 0.8rem; border: 1px solid var(--color-trace); border-radius: 8px; font-family: inherit; font-size: 0.95rem; background: var(--color-surface); color: var(--color-text); transition: border-color 0.2s, box-shadow 0.2s; }
    .admin-modal-reply input[type="text"]:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 2px var(--color-trace-accent); }
    .admin-modal-reply input[readonly] { background: var(--color-bg-alt); cursor: default; }
    .admin-modal-reply .reply-row { margin-bottom: var(--space-md); }
    .admin-modal-reply .reply-toolbar { display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap; margin-top: var(--space-md); padding-top: var(--space-sm); }
    .admin-modal-reply .reply-toolbar button { padding: 0.5rem 1rem; font-size: 0.9rem; border-radius: 8px; }
    .admin-emoji-picker { position: absolute; background: var(--color-surface); border: 1px solid var(--color-trace); border-radius: var(--radius); box-shadow: var(--shadow-lg); padding: var(--space-sm); max-height: 200px; overflow-y: auto; z-index: 10; display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
    .admin-emoji-picker[hidden] { display: none; }
    .admin-emoji-picker span { cursor: pointer; font-size: 1.25rem; padding: 4px; }
    .admin-emoji-picker span:hover { background: var(--color-bg-alt); border-radius: 4px; }
    .admin-attach-zone { border: 2px dashed var(--color-trace); border-radius: 10px; padding: var(--space-lg); text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; background: var(--color-surface); margin-top: var(--space-sm); }
    .admin-attach-zone:hover { border-color: var(--color-accent); background: rgba(180, 83, 9, 0.04); }
    .admin-attach-zone.is-dragover { border-color: var(--color-accent); background: rgba(180, 83, 9, 0.08); }
    .admin-attach-zone.has-files { border-style: solid; padding: var(--space-md); }
    .admin-attach-zone-icon { font-size: 2rem; margin-bottom: var(--space-sm); opacity: 0.7; }
    .admin-attach-zone-text { font-size: 0.9rem; font-weight: 600; color: var(--color-navy); margin-bottom: 2px; }
    .admin-attach-zone-hint { font-size: 0.8rem; color: var(--color-text-muted); }
    .admin-attach-list { font-size: 0.85rem; color: var(--color-text-muted); margin-top: var(--space-sm); display: flex; flex-wrap: wrap; gap: var(--space-sm); }
    .admin-attach-list span { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background: var(--color-bg-alt); border-radius: 6px; }
    .admin-attach-list .remove-attach { cursor: pointer; color: #b91c1c; padding: 0 2px; font-weight: 700; }
    .admin-reply-status { font-size: 0.9rem; margin-left: var(--space-sm); }
    .admin-reply-status.success { color: #15803d; }
    .admin-reply-status.error { color: #b91c1c; }
    .admin-char-count { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 2px; }
    .admin-char-count.near-limit { color: var(--color-accent); }
    .admin-char-count.over-limit { color: #b91c1c; }
    .admin-toolbar .refresh-btn { margin-left: auto; }
    .admin-loading { padding: var(--space-2xl); text-align: center; color: var(--color-text-muted); }
    .admin-loading-spinner { display: inline-block; width: 28px; height: 28px; border: 2px solid var(--color-trace); border-top-color: var(--color-accent); border-radius: 50%; animation: admin-spin 0.8s linear infinite; margin-bottom: var(--space-sm); }
    @keyframes admin-spin { to { transform: rotate(360deg); } }
    .admin-emailrow.unread .from-name { font-weight: 700; }
    .admin-emailrow.unread .subject { font-weight: 700; }
    .admin-modal-overlay { opacity: 0; transition: opacity 0.2s ease; }
    .admin-modal-overlay.is-open { opacity: 1; }
    .admin-modal-box { transform: scale(0.98); transition: transform 0.2s ease; }
    .admin-modal-overlay.is-open .admin-modal-box { transform: scale(1); }
    .admin-pagination { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--space-sm); padding: var(--space-md) var(--space-lg); border-top: 1px solid var(--color-trace); background: var(--color-surface); }
    .admin-pagination-info { font-size: 0.9rem; color: var(--color-text-muted); }
    .admin-pagination-btns { display: flex; gap: var(--space-sm); }
    .admin-pagination-btns .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .admin-format-toolbar { display: flex; gap: 2px; margin-bottom: 4px; }
    .admin-format-toolbar button { width: 34px; height: 34px; padding: 0; border: 1px solid var(--color-trace); border-radius: 8px; background: var(--color-surface); color: var(--color-navy); cursor: pointer; font-size: 0.9rem; font-weight: 700; transition: background 0.2s, border-color 0.2s; }
    .admin-format-toolbar button:hover { background: var(--color-bg-alt); border-color: var(--color-accent); }
    .admin-format-toolbar button.active { background: var(--color-bg-alt); color: var(--color-accent); }
    .admin-reply-body-editor { min-height: 120px; padding: 0.6rem 0.75rem; border: 1px solid var(--color-trace); border-radius: 8px; font-family: inherit; font-size: 0.95rem; background: var(--color-surface); color: var(--color-text); line-height: 1.5; }
    .admin-reply-body-editor:focus { outline: 2px solid var(--color-accent); outline-offset: 2px; }
    .admin-reply-body-editor[data-placeholder]:empty::before { content: attr(data-placeholder); color: var(--color-text-muted); }

    @media (max-width: 768px) {
      .admin-app { flex-direction: column; }
      .admin-sidebar { width: 100%; display: flex; flex-wrap: wrap; gap: 0; padding: var(--space-sm); border-right: none; border-bottom: 1px solid var(--color-trace); }
      .admin-sidebar .nav-item { flex: 1 1 auto; }
      .admin-sidebar .logout-wrap { width: 100%; border-top: 1px solid var(--color-trace); }
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <a href="/" class="admin-header-logo">Schmiedeler &amp; Associates</a>
      <div style="display: flex; align-items: center; gap: var(--space-md);">
        <button type="button" class="admin-theme-toggle" id="admin-theme-toggle" aria-label="Toggle dark mode" title="Dark mode">
          <span class="admin-theme-icon admin-theme-sun" aria-hidden="true">‚òÄ</span>
          <span class="admin-theme-icon admin-theme-moon" aria-hidden="true">‚òΩ</span>
        </button>
        <a href="/" class="admin-header-portal">Back to site</a>
      </div>
    </div>
  </header>

  <div id="admin-login-wrap" class="admin-login-wrap">
    <h1 class="admin-title" style="font-family: var(--font-heading); margin-bottom: var(--space-md);">Admin inbox</h1>
    <p class="section-intro" style="margin-bottom: var(--space-md);">Sign in with your admin key to view and reply to messages.</p>
    <div id="admin-login" class="admin-login">
      <label for="admin-key">Admin key</label>
      <input type="password" id="admin-key" placeholder="Enter admin key" autocomplete="off" />
      <button type="button" class="btn btn-primary" id="admin-load">Sign in</button>
      <p id="admin-error" class="admin-error" hidden></p>
    </div>
  </div>

  <div id="admin-app" class="admin-app" hidden>
    <aside class="admin-sidebar">
      <button type="button" class="nav-item active" data-dept="general">General <span class="nav-count" id="count-general">0</span></button>
      <button type="button" class="nav-item" data-dept="sales">Sales <span class="nav-count" id="count-sales">0</span></button>
      <button type="button" class="nav-item" data-dept="accounting">Accounting <span class="nav-count" id="count-accounting">0</span></button>
      <div class="admin-gmail-wrap">
        <button type="button" class="btn btn-secondary btn-sm" id="admin-connect-gmail" hidden>Connect Gmail</button>
        <span class="admin-gmail-status" id="admin-gmail-status" hidden>Gmail connected</span>
      </div>
      <div class="logout-wrap">
        <button type="button" class="btn btn-secondary" id="admin-logout">Log out</button>
      </div>
    </aside>
    <main class="admin-main">
      <div class="admin-toolbar" id="admin-toolbar">
        <span id="admin-toolbar-label" class="admin-toolbar-label">Inbox ‚Äî General</span>
        <button type="button" class="btn btn-secondary btn-sm refresh-btn" id="admin-refresh" aria-label="Refresh inbox">Refresh</button>
      </div>
      <div class="admin-loading" id="admin-loading" hidden><div class="admin-loading-spinner" aria-hidden="true"></div><div>Loading inbox‚Ä¶</div></div>
      <div class="admin-emaillist" id="admin-emaillist"></div>
      <nav class="admin-pagination" id="admin-pagination" aria-label="Inbox pagination" hidden>
        <span class="admin-pagination-info" id="admin-pagination-info"></span>
        <div class="admin-pagination-btns">
          <button type="button" class="btn btn-secondary btn-sm" id="admin-pagination-prev" aria-label="Previous page">Previous</button>
          <button type="button" class="btn btn-secondary btn-sm" id="admin-pagination-next" aria-label="Next page">Next</button>
        </div>
      </nav>
      <div class="admin-empty-inbox" id="admin-empty-inbox" hidden><span class="empty-icon" aria-hidden="true">üì≠</span><p>No messages in this department.</p><p id="admin-empty-hint" style="font-size: 0.9rem;">Contact form submissions and emails sent to this address will appear here.</p></div>
    </main>
  </div>

  <div id="admin-modal" class="admin-modal-overlay" hidden role="dialog" aria-modal="true" aria-labelledby="modal-subject" aria-describedby="modal-from">
    <div class="admin-modal-box">
      <div class="admin-modal-header">
        <div class="admin-modal-header-content">
          <span class="admin-modal-dept-badge" id="modal-dept-badge">General</span>
          <h2 id="modal-subject">Subject</h2>
        </div>
        <button type="button" class="admin-modal-close" id="modal-close" aria-label="Close message">&times;</button>
      </div>
      <div class="admin-modal-body">
        <div class="admin-modal-inbound">
          <div class="admin-modal-section-label" id="modal-inbound-label">Inbound message (from customer)</div>
          <div class="admin-modal-email-from" id="modal-from"></div>
          <div class="admin-modal-email-to" id="modal-to"></div>
          <div class="admin-modal-email-date" id="modal-date"></div>
          <div class="admin-modal-email-msg" id="modal-msg"></div>
        </div>
      </div>
      <div class="admin-modal-reply">
        <div class="admin-modal-section-label">Your reply <span class="admin-reply-from-note">(sent from this department‚Äôs @schmiedeler.com address)</span></div>
        <div class="reply-row">
          <label for="reply-subject">Subject</label>
          <input type="text" id="reply-subject" placeholder="Re: ..." aria-label="Reply subject" />
        </div>
        <div class="reply-row">
          <label>To</label>
          <input type="text" id="reply-to" readonly aria-readonly="true" />
        </div>
        <div class="reply-row">
          <label for="reply-cc">CC (optional)</label>
          <input type="text" id="reply-cc" placeholder="email@example.com, another@example.com" aria-label="CC recipients" />
        </div>
        <div class="reply-row">
          <label for="reply-body">Message</label>
          <div class="admin-format-toolbar">
            <button type="button" id="format-bold" title="Bold" aria-label="Bold">B</button>
            <button type="button" id="format-italic" title="Italic" aria-label="Italic"><em>I</em></button>
            <button type="button" id="format-underline" title="Underline" aria-label="Underline"><u>U</u></button>
          </div>
          <div style="position: relative;">
            <div id="reply-body" class="admin-reply-body-editor" contenteditable="true" role="textbox" aria-multiline="true" aria-label="Reply message" data-placeholder="Type your reply..."></div>
            <div id="reply-char-count" class="admin-char-count" aria-live="polite">0 / 10,000 characters</div>
            <div class="admin-emoji-picker" id="emoji-picker" hidden role="listbox" aria-label="Choose emoji"></div>
          </div>
          <button type="button" class="btn btn-secondary btn-sm" id="reply-emoji-btn" style="margin-top: 6px;" aria-expanded="false" aria-haspopup="listbox">Insert emoji</button>
        </div>
        <div class="reply-row">
          <label>Attachments</label>
          <input type="file" id="reply-attach" multiple hidden accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv" />
          <div class="admin-attach-zone" id="admin-attach-zone" role="button" tabindex="0" aria-label="Click or drop files to upload attachments">
            <div class="admin-attach-zone-icon" id="attach-zone-icon" aria-hidden="true">üìé</div>
            <div class="admin-attach-zone-text" id="attach-zone-text">Click or drop files to upload attachments</div>
            <div class="admin-attach-zone-hint" id="attach-zone-hint">Images, video, PDF, Word, Excel ‚Äî max 4 MB per file, 10 MB total</div>
          </div>
          <div class="admin-attach-list" id="reply-attach-list"></div>
        </div>
        <div class="reply-toolbar">
          <button type="button" class="btn btn-primary" id="reply-send">Send reply</button>
          <button type="button" class="btn btn-secondary" id="reply-cancel">Cancel</button>
          <span class="admin-reply-status" id="reply-status" aria-live="polite"></span>
        </div>
        <p class="admin-reply-hint" style="margin-top: var(--space-sm); margin-bottom: 0; font-size: 0.8rem; color: var(--color-text-muted);">Replies are sent via your department @schmiedeler.com address; the recipient will see that address as the sender.</p>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var keyInput = document.getElementById('admin-key');
      var loadBtn = document.getElementById('admin-load');
      var errorEl = document.getElementById('admin-error');
      var loginWrap = document.getElementById('admin-login-wrap');
      var appEl = document.getElementById('admin-app');
      var emaillistEl = document.getElementById('admin-emaillist');
      var emptyInboxEl = document.getElementById('admin-empty-inbox');
      var toolbarEl = document.getElementById('admin-toolbar');
      var logoutBtn = document.getElementById('admin-logout');
      var modalEl = document.getElementById('admin-modal');
      var modalClose = document.getElementById('modal-close');
      var modalSubject = document.getElementById('modal-subject');
      var modalFrom = document.getElementById('modal-from');
      var modalTo = document.getElementById('modal-to');
      var modalDate = document.getElementById('modal-date');
      var modalMsg = document.getElementById('modal-msg');
      var replySubject = document.getElementById('reply-subject');
      var replyTo = document.getElementById('reply-to');
      var replyCc = document.getElementById('reply-cc');
      var replyBody = document.getElementById('reply-body');
      var replySend = document.getElementById('reply-send');
      var replyCancel = document.getElementById('reply-cancel');
      var replyStatus = document.getElementById('reply-status');
      var replyEmojiBtn = document.getElementById('reply-emoji-btn');
      var emojiPicker = document.getElementById('emoji-picker');
      var replyAttach = document.getElementById('reply-attach');
      var adminAttachZone = document.getElementById('admin-attach-zone');
      var attachZoneText = document.getElementById('attach-zone-text');
      var attachZoneHint = document.getElementById('attach-zone-hint');
      var attachZoneIcon = document.getElementById('attach-zone-icon');
      var replyAttachList = document.getElementById('reply-attach-list');

      var STORAGE_KEY = 'schmiedeler_admin_key';
      var DEPT_LABELS = { general: 'General', sales: 'Sales', accounting: 'Accounting' };
      var DEPT_EMAILS = { general: 'info@schmiedeler.com', sales: 'sales@schmiedeler.com', accounting: 'accounting@schmiedeler.com' };
      var EMOJIS = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','üëç','üëé','üëå','‚úåÔ∏è','ü§û','ü§ü','ü§ò','üëè','üôå','üí™','üìß','üì®','‚úâÔ∏è','üì©','üíº','üìã','‚úÖ','‚ùå','‚≠ê','üôè'];
      var submissions = [];
      var currentDept = 'general';
      var currentSubmission = null;
      var selectedFiles = [];
      var OPENED_IDS_KEY = 'schmiedeler_admin_opened';
      var THEME_KEY = 'schmiedeler_admin_theme';
      var MAX_BODY_LEN = 10000;
      var PAGE_SIZE = 20;
      var currentPage = 1;
      var modalFocusables;

      function showError(msg) {
        errorEl.textContent = msg || '';
        errorEl.hidden = !msg;
      }

      function getAuthKey() {
        return sessionStorage.getItem(STORAGE_KEY) || (keyInput && keyInput.value ? keyInput.value.trim() : '');
      }

      function getOpenedIds() {
        try {
          var raw = sessionStorage.getItem(OPENED_IDS_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch (e) { return {}; }
      }
      function markOpened(id) {
        var o = getOpenedIds();
        o[id] = true;
        try { sessionStorage.setItem(OPENED_IDS_KEY, JSON.stringify(o)); } catch (e) {}
      }

      function loadSubmissions(key) {
        showError('');
        var loadingEl = document.getElementById('admin-loading');
        if (loadingEl) loadingEl.hidden = false;
        if (loadBtn) { loadBtn.disabled = true; loadBtn.textContent = 'Signing in‚Ä¶'; }
        Promise.all([
          fetch('/api/submissions', { method: 'GET', headers: { 'Authorization': 'Bearer ' + key } }).then(function (r) {
            if (r.status === 401) return null;
            return r.json();
          }),
          fetch('/api/gmail-inbox', { method: 'GET', headers: { 'Authorization': 'Bearer ' + key } }).then(function (r) {
            return r.json();
          })
        ])
          .then(function (arr) {
            var data = arr[0];
            var gmailData = arr[1] || {};
            if (loadingEl) loadingEl.hidden = true;
            if (loadBtn) { loadBtn.disabled = false; loadBtn.textContent = 'Sign in'; }
            if (!data) {
              sessionStorage.removeItem(STORAGE_KEY);
              showError('Invalid key. Please try again.');
              return;
            }
            if (data.error && !data.submissions) {
              showError(data.error || 'Failed to load.');
              return;
            }
            loginWrap.hidden = true;
            appEl.hidden = false;
            sessionStorage.setItem(STORAGE_KEY, key);

            var kvList = (data.submissions || []).map(function (s) {
              s.source = s.source || 'form';
              s.createdAt = s.createdAt || '';
              return s;
            });
            var gmailList = (gmailData.gmail || []).map(function (m) {
              return {
                id: m.id,
                name: m.name,
                email: m.email,
                toEmail: m.toEmail,
                subject: m.subject,
                message: m.message,
                createdAt: m.createdAt,
                department: m.department,
                source: 'gmail'
              };
            });
            submissions = kvList.concat(gmailList).sort(function (a, b) {
              var tA = new Date(a.createdAt).getTime();
              var tB = new Date(b.createdAt).getTime();
              return tB - tA;
            });

            var connectBtn = document.getElementById('admin-connect-gmail');
            var statusEl = document.getElementById('admin-gmail-status');
            if (gmailData.gmailConnected) {
              if (connectBtn) connectBtn.hidden = true;
              if (statusEl) { statusEl.hidden = false; statusEl.textContent = 'Gmail connected'; }
              updateCounts();
              renderList();
            } else {
              if (connectBtn) connectBtn.hidden = true;
              if (statusEl) statusEl.hidden = true;
              fetch('/api/gmail-auth-url', { method: 'GET', headers: { 'Authorization': 'Bearer ' + key } })
                .then(function (r) { return r.json(); })
                .then(function (authData) {
                  if (authData && authData.url) {
                    window.location = authData.url;
                    return;
                  }
                  if (connectBtn) connectBtn.hidden = false;
                  updateCounts();
                  renderList();
                })
                .catch(function () {
                  if (connectBtn) connectBtn.hidden = false;
                  updateCounts();
                  renderList();
                });
            }
          })
          .catch(function () {
            if (loadingEl) loadingEl.hidden = true;
            if (loadBtn) { loadBtn.disabled = false; loadBtn.textContent = 'Sign in'; }
            showError('Network error.');
          });
      }

      function groupByDept(list) {
        var g = { general: [], sales: [], accounting: [] };
        list.forEach(function (s) {
          var d = (s.department && g[s.department]) ? s.department : 'general';
          g[d].push(s);
        });
        return g;
      }

      function updateCounts() {
        var g = groupByDept(submissions);
        ['general','sales','accounting'].forEach(function (d) {
          var el = document.getElementById('count-' + d);
          if (el) el.textContent = (g[d] || []).length;
        });
      }

      function escapeHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function snippet(text, maxLen) {
        if (!text) return '';
        text = text.replace(/\s+/g, ' ').trim();
        return text.length <= (maxLen || 80) ? text : text.slice(0, maxLen || 80) + '‚Ä¶';
      }

      function initial(name) {
        if (!name || !name.trim()) return '?';
        var parts = name.trim().split(/\s+/);
        if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        return name.trim()[0].toUpperCase();
      }

      function formatRelativeDate(isoStr) {
        if (!isoStr) return '‚Äî';
        var d = new Date(isoStr);
        var now = new Date();
        var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        var yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        var dDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        if (dDate.getTime() === today.getTime()) return 'Today ' + d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        if (dDate.getTime() === yesterday.getTime()) return 'Yesterday ' + d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        if (d.getFullYear() === now.getFullYear()) return d.toLocaleDateString([], { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        return d.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function getReplyText() {
        return replyBody ? (replyBody.innerText || '').trim() : '';
      }
      function getReplyHtml() {
        return replyBody ? (replyBody.innerHTML || '').trim() : '';
      }

      function updateCharCount() {
        var el = document.getElementById('reply-char-count');
        if (!el) return;
        var len = (replyBody && replyBody.innerText) ? replyBody.innerText.length : 0;
        el.textContent = len.toLocaleString() + ' / 10,000 characters';
        el.className = 'admin-char-count' + (len >= MAX_BODY_LEN ? ' over-limit' : len >= MAX_BODY_LEN - 500 ? ' near-limit' : '');
      }

      function renderList() {
        var g = groupByDept(submissions);
        var list = g[currentDept] || [];
        var total = list.length;
        var totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;
        var start = (currentPage - 1) * PAGE_SIZE;
        var pageList = list.slice(start, start + PAGE_SIZE);

        var labelEl = document.getElementById('admin-toolbar-label');
        if (labelEl) labelEl.textContent = 'Inbox ‚Äî ' + DEPT_LABELS[currentDept] + ' (' + DEPT_EMAILS[currentDept] + ')';
        emaillistEl.innerHTML = '';
        emptyInboxEl.hidden = total > 0;
        var emptyHint = document.getElementById('admin-empty-hint');
        if (emptyHint) emptyHint.textContent = 'Contact form submissions and emails sent to ' + (DEPT_EMAILS[currentDept] || 'this address') + ' will appear here.';

        var paginationEl = document.getElementById('admin-pagination');
        var paginationInfo = document.getElementById('admin-pagination-info');
        var paginationPrev = document.getElementById('admin-pagination-prev');
        var paginationNext = document.getElementById('admin-pagination-next');
        if (total > 0 && paginationEl) {
          paginationEl.hidden = false;
          if (paginationInfo) paginationInfo.textContent = 'Showing ' + (start + 1) + '‚Äì' + Math.min(start + PAGE_SIZE, total) + ' of ' + total;
          if (paginationPrev) { paginationPrev.disabled = currentPage <= 1; paginationPrev.ariaDisabled = currentPage <= 1; }
          if (paginationNext) { paginationNext.disabled = currentPage >= totalPages; paginationNext.ariaDisabled = currentPage >= totalPages; }
        } else if (paginationEl) paginationEl.hidden = true;

        var opened = getOpenedIds();
        pageList.forEach(function (s) {
          var row = document.createElement('div');
          row.className = 'admin-emailrow' + (opened[s.id] ? '' : ' unread');
          row.setAttribute('role', 'button');
          row.tabIndex = 0;
          row.setAttribute('aria-label', (s.subject || 'No subject') + ', from ' + (s.name || ''));
          var dateStr = formatRelativeDate(s.createdAt);
          row.innerHTML =
            '<span class="avatar">' + escapeHtml(initial(s.name)) + '</span>' +
            '<div class="meta">' +
              '<div class="from-line"><span class="from-name">' + escapeHtml(s.name || '') + '</span><span class="date">' + escapeHtml(dateStr) + '</span></div>' +
              '<div class="subject">' + escapeHtml(s.subject || '‚Äî') + '</div>' +
              '<div class="snippet">' + escapeHtml(snippet(s.message)) + '</div>' +
            '</div>';
          row.addEventListener('click', function () { openModal(s); });
          row.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openModal(s); } });
          emaillistEl.appendChild(row);
        });
      }

      function hasDraft() {
        return getReplyText().length > 0 || selectedFiles.length > 0;
      }

      function openModal(s) {
        currentSubmission = s;
        selectedFiles = [];
        replyAttach.value = '';
        replyAttachList.innerHTML = '';
        updateAttachList();
        replyCc.value = '';
        replyBody.innerHTML = '';
        replyStatus.textContent = '';
        replyStatus.className = 'admin-reply-status';
        emojiPicker.hidden = true;
        if (replyEmojiBtn) replyEmojiBtn.setAttribute('aria-expanded', 'false');

        var subj = s.subject || '';
        modalSubject.textContent = subj || '‚Äî';
        var deptBadge = document.getElementById('modal-dept-badge');
        if (deptBadge) {
          deptBadge.textContent = DEPT_LABELS[s.department] || 'General';
          deptBadge.className = 'admin-modal-dept-badge' + (s.department === 'sales' ? ' dept-sales' : s.department === 'accounting' ? ' dept-accounting' : '');
        }
        modalFrom.innerHTML = '<strong>From:</strong> ' + escapeHtml(s.name || '') + ' &lt;' + escapeHtml(s.email || '') + '&gt;';
        modalTo.innerHTML = '<strong>To:</strong> ' + escapeHtml(s.toEmail || DEPT_EMAILS[s.department] || '‚Äî');
        modalDate.textContent = formatRelativeDate(s.createdAt);
        modalMsg.textContent = s.message || '‚Äî';
        replyTo.value = s.email || '';
        replySubject.value = subj ? (subj.toLowerCase().indexOf('re:') === 0 ? subj : 'Re: ' + subj) : 'Re: Your message';
        updateCharCount();
        modalEl.hidden = false;
        modalEl.classList.add('is-open');
        markOpened(s.id);
        renderList();
        setTimeout(function () {
          modalFocusables = modalEl.querySelectorAll('button, [href], input, select, textarea, [contenteditable="true"], [tabindex]:not([tabindex="-1"])');
          if (modalFocusables.length) modalFocusables[0].focus();
          else if (replyBody) replyBody.focus();
        }, 50);
      }

      function closeModal(force) {
        if (!force && hasDraft() && !confirm('Discard your reply?')) return;
        modalEl.hidden = true;
        modalEl.classList.remove('is-open');
        currentSubmission = null;
      }

      modalClose.addEventListener('click', function () { closeModal(); });
      modalEl.addEventListener('click', function (e) {
        if (e.target === modalEl) closeModal();
      });
      document.addEventListener('keydown', function (e) {
        if (e.key !== 'Escape') return;
        if (!modalEl.hidden) { e.preventDefault(); closeModal(); return; }
        if (!emojiPicker.hidden) { e.preventDefault(); emojiPicker.hidden = true; if (replyEmojiBtn) replyEmojiBtn.setAttribute('aria-expanded', 'false'); }
      });
      modalEl.addEventListener('keydown', function (e) {
        if (e.key !== 'Tab' || !modalFocusables || !modalFocusables.length) return;
        var first = modalFocusables[0];
        var last = modalFocusables[modalFocusables.length - 1];
        if (e.shiftKey) {
          if (document.activeElement === first) { e.preventDefault(); last.focus(); }
        } else {
          if (document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      });

      if (replyBody) {
        replyBody.addEventListener('input', updateCharCount);
        replyBody.addEventListener('paste', function (e) {
          e.preventDefault();
          var text = (e.clipboardData || window.clipboardData).getData('text/plain');
          document.execCommand('insertText', false, text);
        });
      }

      document.getElementById('format-bold').addEventListener('click', function () { replyBody.focus(); document.execCommand('bold', false, null); });
      document.getElementById('format-italic').addEventListener('click', function () { replyBody.focus(); document.execCommand('italic', false, null); });
      document.getElementById('format-underline').addEventListener('click', function () { replyBody.focus(); document.execCommand('underline', false, null); });

      replyEmojiBtn.addEventListener('click', function () {
        emojiPicker.hidden = !emojiPicker.hidden;
        replyEmojiBtn.setAttribute('aria-expanded', emojiPicker.hidden ? 'false' : 'true');
        if (!emojiPicker.hidden && !emojiPicker.children.length) {
          emojiPicker.innerHTML = '';
          EMOJIS.forEach(function (emo) {
            var span = document.createElement('span');
            span.textContent = emo;
            span.setAttribute('role', 'button');
            span.addEventListener('click', function () {
              replyBody.focus();
              document.execCommand('insertText', false, emo);
              updateCharCount();
            });
            emojiPicker.appendChild(span);
          });
        }
      });

      function triggerAttachInput() { if (replyAttach) replyAttach.click(); }
      if (adminAttachZone) {
        adminAttachZone.addEventListener('click', function (e) { if (e.target.closest('.remove-attach')) return; triggerAttachInput(); });
        adminAttachZone.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); triggerAttachInput(); } });
        adminAttachZone.addEventListener('dragover', function (e) { e.preventDefault(); e.stopPropagation(); adminAttachZone.classList.add('is-dragover'); });
        adminAttachZone.addEventListener('dragleave', function (e) { e.preventDefault(); adminAttachZone.classList.remove('is-dragover'); });
        adminAttachZone.addEventListener('drop', function (e) {
          e.preventDefault();
          adminAttachZone.classList.remove('is-dragover');
          var files = e.dataTransfer && e.dataTransfer.files;
          if (files && files.length) for (var i = 0; i < files.length; i++) selectedFiles.push({ file: files[i], id: Date.now() + '-' + i });
          updateAttachList();
        });
      }
      replyAttach.addEventListener('change', function () {
        var files = replyAttach.files;
        for (var i = 0; i < files.length; i++) {
          selectedFiles.push({ file: files[i], id: Date.now() + '-' + i });
        }
        replyAttach.value = '';
        updateAttachList();
      });

      function updateAttachList() {
        replyAttachList.innerHTML = '';
        selectedFiles.forEach(function (item) {
          var span = document.createElement('span');
          span.innerHTML = escapeHtml(item.file.name) + ' <button type="button" class="remove-attach" data-id="' + item.id + '">√ó</button>';
          span.querySelector('.remove-attach').addEventListener('click', function (e) { e.stopPropagation(); selectedFiles = selectedFiles.filter(function (x) { return x.id !== item.id; }); updateAttachList(); });
          replyAttachList.appendChild(span);
        });
        if (attachZoneText) attachZoneText.textContent = selectedFiles.length ? selectedFiles.length + ' file(s) attached ‚Äî click to add more' : 'Click or drop files to upload attachments';
        if (attachZoneHint) attachZoneHint.textContent = selectedFiles.length ? '' : 'Images, video, PDF, Word, Excel ‚Äî max 4 MB per file, 10 MB total';
        if (adminAttachZone) adminAttachZone.classList.toggle('has-files', selectedFiles.length > 0);
        if (attachZoneIcon) attachZoneIcon.textContent = selectedFiles.length ? 'üìÅ' : 'üìé';
      }

      function readFileAsBase64(file) {
        return new Promise(function (resolve, reject) {
          var reader = new FileReader();
          reader.onload = function () {
            var b = reader.result;
            if (b.indexOf('base64,') !== -1) b = b.slice(b.indexOf('base64,') + 7);
            resolve({ filename: file.name, content: b });
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      replySend.addEventListener('click', function () {
        var msg = getReplyText();
        if (!msg) {
          replyStatus.textContent = 'Please enter a message.';
          replyStatus.className = 'admin-reply-status error';
          return;
        }
        if (!currentSubmission) return;
        replyStatus.textContent = 'Sending‚Ä¶';
        replyStatus.className = 'admin-reply-status';
        replySend.disabled = true;

        var ccStr = (replyCc && replyCc.value) ? replyCc.value.trim() : '';
        var ccList = ccStr ? ccStr.split(/[\s,;]+/).map(function (e) { return e.trim(); }).filter(Boolean) : [];
        var subjectStr = (replySubject && replySubject.value) ? replySubject.value.trim() : (currentSubmission.subject ? 'Re: ' + currentSubmission.subject : 'Re: Your message');
        var htmlBody = getReplyHtml();

        Promise.all(selectedFiles.map(function (item) { return readFileAsBase64(item.file); }))
          .then(function (attachments) {
            var payload;
            if (currentSubmission.source === 'gmail') {
              payload = {
                toEmail: currentSubmission.email,
                department: currentSubmission.department,
                message: msg,
                subject: subjectStr,
                cc: ccList.length ? ccList : undefined,
                attachments: attachments.length ? attachments : undefined
              };
            } else {
              payload = {
                id: currentSubmission.id,
                message: msg,
                subject: subjectStr,
                cc: ccList.length ? ccList : undefined,
                attachments: attachments.length ? attachments : undefined
              };
            }
            if (htmlBody && htmlBody !== '<br>') payload.html = htmlBody;
            return fetch('/api/reply', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getAuthKey()
              },
              body: JSON.stringify(payload)
            });
          })
          .then(function (r) { return r.json().then(function (data) { return { status: r.status, data: data }; }); })
          .then(function (res) {
            replySend.disabled = false;
            if (res.status === 200 && res.data.success) {
              replyStatus.textContent = 'Reply sent.';
              replyStatus.className = 'admin-reply-status success';
              replyBody.innerHTML = '';
              selectedFiles = [];
              replyAttachList.innerHTML = '';
              updateCharCount();
              setTimeout(function () { closeModal(true); }, 1500);
            } else {
              replyStatus.textContent = res.data.error || 'Failed to send reply.';
              replyStatus.className = 'admin-reply-status error';
            }
          })
          .catch(function () {
            replySend.disabled = false;
            replyStatus.textContent = 'Network error.';
            replyStatus.className = 'admin-reply-status error';
          });
      });

      replyCancel.addEventListener('click', closeModal);

      document.querySelectorAll('.admin-sidebar .nav-item[data-dept]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          currentDept = btn.getAttribute('data-dept');
          currentPage = 1;
          document.querySelectorAll('.admin-sidebar .nav-item').forEach(function (b) { b.classList.remove('active'); });
          btn.classList.add('active');
          renderList();
        });
      });

      var paginationPrev = document.getElementById('admin-pagination-prev');
      var paginationNext = document.getElementById('admin-pagination-next');
      if (paginationPrev) paginationPrev.addEventListener('click', function () {
        if (currentPage > 1) { currentPage--; renderList(); }
      });
      if (paginationNext) paginationNext.addEventListener('click', function () {
        var g = groupByDept(submissions);
        var list = g[currentDept] || [];
        if (currentPage < Math.ceil(list.length / PAGE_SIZE)) { currentPage++; renderList(); }
      });

      (function initTheme() {
        try {
          var theme = localStorage.getItem(THEME_KEY) || '';
          if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
          else document.documentElement.removeAttribute('data-theme');
        } catch (e) {}
        var themeBtn = document.getElementById('admin-theme-toggle');
        if (themeBtn) themeBtn.addEventListener('click', function () {
          var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
          try { localStorage.setItem(THEME_KEY, isDark ? 'light' : 'dark'); } catch (e) {}
        });
      })();

      var refreshBtn = document.getElementById('admin-refresh');
      if (refreshBtn) refreshBtn.addEventListener('click', function () {
        var key = getAuthKey();
        if (!key) return;
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'Refreshing‚Ä¶';
        Promise.all([
          fetch('/api/submissions', { method: 'GET', headers: { 'Authorization': 'Bearer ' + key } }).then(function (r) { return r.status === 401 ? null : r.json(); }),
          fetch('/api/gmail-inbox', { method: 'GET', headers: { 'Authorization': 'Bearer ' + key } }).then(function (r) { return r.json(); })
        ])
          .then(function (arr) {
            var data = arr[0];
            var gmailData = arr[1] || {};
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'Refresh';
            if (!data || (data.error && !data.submissions)) return;
            var kvList = (data.submissions || []).map(function (s) { s.source = s.source || 'form'; s.createdAt = s.createdAt || ''; return s; });
            var gmailList = (gmailData.gmail || []).map(function (m) {
              return { id: m.id, name: m.name, email: m.email, toEmail: m.toEmail, subject: m.subject, message: m.message, createdAt: m.createdAt, department: m.department, source: 'gmail' };
            });
            submissions = kvList.concat(gmailList).sort(function (a, b) { return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(); });
            var connectBtn = document.getElementById('admin-connect-gmail');
            var statusEl = document.getElementById('admin-gmail-status');
            if (gmailData.gmailConnected) { if (connectBtn) connectBtn.hidden = true; if (statusEl) { statusEl.hidden = false; statusEl.textContent = 'Gmail connected'; } }
            else { if (connectBtn) connectBtn.hidden = false; if (statusEl) statusEl.hidden = true; }
            updateCounts();
            renderList();
          })
          .catch(function () { refreshBtn.disabled = false; refreshBtn.textContent = 'Refresh'; });
      });

      loadBtn.addEventListener('click', function () {
        var key = (keyInput && keyInput.value) ? keyInput.value.trim() : '';
        if (!key) { showError('Enter the admin key.'); return; }
        loadSubmissions(key);
      });
      keyInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') loadBtn.click(); });
      logoutBtn.addEventListener('click', function () {
        sessionStorage.removeItem(STORAGE_KEY);
        appEl.hidden = true;
        loginWrap.hidden = false;
        keyInput.value = '';
        showError('');
      });

      var connectGmailBtn = document.getElementById('admin-connect-gmail');
      if (connectGmailBtn) connectGmailBtn.addEventListener('click', function () {
        var key = getAuthKey();
        if (!key) return;
        fetch('/api/gmail-auth-url', { method: 'GET', headers: { 'Authorization': 'Bearer ' + key } })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data && data.url) window.location = data.url;
            else showError('Could not get Gmail sign-in URL.');
          })
          .catch(function () { showError('Network error.'); });
      });

      var saved = sessionStorage.getItem(STORAGE_KEY);
      if (saved) {
        keyInput.value = '';
        loadSubmissions(saved);
      } else {
        appEl.hidden = true;
      }
      var params = new URLSearchParams(window.location.search);
      if (params.get('gmail') === 'connected') {
        try { history.replaceState(null, '', window.location.pathname + (window.location.hash || '')); } catch (e) {}
        showError('');
        var statusEl = document.getElementById('admin-gmail-status');
        if (statusEl) { statusEl.hidden = false; statusEl.textContent = 'Gmail connected'; statusEl.classList.add('flash'); setTimeout(function () { statusEl.classList.remove('flash'); }, 2000); }
      }
      if (params.get('gmail') === 'denied' || params.get('gmail') === 'error') {
        try { history.replaceState(null, '', window.location.pathname + (window.location.hash || '')); } catch (e) {}
        showError(params.get('gmail') === 'denied' ? 'Gmail access was denied.' : 'Gmail connection failed.');
      }
    })();
  </script>
</body>
</html>
